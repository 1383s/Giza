<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ELGIZAWY - Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ğŸ‘‘ | Full Mark</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #0f172a; --bg-card: #1e293b; --bg-hover: #334155;
            --primary: #3b82f6; --primary-dark: #2563eb; --secondary: #8b5cf6;
            --text-main: #f1f5f9; --text-muted: #94a3b8;
            --success: #10b981; --danger: #ef4444; --warning: #f59e0b;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); --glow: 0 0 15px rgba(59, 130, 246, 0.3);
            --radius: 12px;
        }

        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; outline: none; }
        
        body { 
            background-color: var(--bg-body);
            background-image: radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            color: var(--text-main); margin: 0; padding: 0; min-height: 100vh;
        }

        /* --- Login --- */
        #loginContainer {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 90%; max-width: 400px; background: rgba(30, 41, 59, 0.9);
            backdrop-filter: blur(12px); padding: 40px; border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255,255,255,0.1); text-align: center;
        }
        #loginContainer h2 { color: var(--primary); margin-bottom: 30px; font-weight: 900; font-size: 2rem; }
        #loginContainer input { background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; margin-bottom: 15px; padding: 15px; width: 100%; transition: 0.3s; }
        #loginContainer input:focus { border-color: var(--primary); box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2); }
        
        /* --- Layout --- */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; animation: fadeIn 0.5s ease-in-out; }
        
        header {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px);
            padding: 15px 25px; border-radius: var(--radius); margin-bottom: 30px;
            border: 1px solid rgba(255,255,255,0.05); box-shadow: var(--shadow);
        }
        h1 { margin: 0; font-size: 1.5rem; background: linear-gradient(to right, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 800; }
        
        /* --- Buttons --- */
        button { border: none; cursor: pointer; transition: all 0.2s ease; font-weight: 700; }
        button:active { transform: scale(0.96); }

        .btn-logout { background: rgba(239, 68, 68, 0.15); color: var(--danger); padding: 8px 16px; border-radius: 8px; }
        .btn-logout:hover { background: var(--danger); color: white; }

        .btn-primary { background: linear-gradient(135deg, var(--primary), var(--secondary)); color: white; padding: 12px 24px; border-radius: 50px; box-shadow: var(--glow); width: 100%; max-width: 250px; display: block; margin: 20px auto; font-size: 1.1rem; }
        .btn-primary:hover { box-shadow: 0 0 25px rgba(59, 130, 246, 0.6); transform: translateY(-2px); }

        .action-btn { padding: 6px 12px; border-radius: 6px; font-size: 0.85rem; margin: 2px; }
        .btn-edit { background: rgba(59, 130, 246, 0.15); color: var(--primary); }
        .btn-edit:hover { background: var(--primary); color: white; }
        .btn-block { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
        .btn-block:hover { background: var(--warning); color: white; }
        .btn-delete { background: rgba(239, 68, 68, 0.15); color: var(--danger); }
        .btn-delete:hover { background: var(--danger); color: white; }
        .btn-eject { background: rgba(139, 92, 246, 0.15); color: var(--secondary); }
        .btn-eject:hover { background: var(--secondary); color: white; }
        
        .btn-copy-code {
            background: rgba(255,255,255,0.1); color: var(--secondary);
            border: 1px solid var(--secondary); padding: 5px 10px;
            border-radius: 6px; margin-right: 8px; font-size: 0.8rem;
        }
        .btn-copy-code:hover { background: var(--secondary); color: white; }

        /* --- Tiles --- */
        .admin-tiles { display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 20px; margin-bottom: 40px; }
        .admin-tile {
            background: var(--bg-card); padding: 25px; border-radius: 16px; text-align: center; cursor: pointer;
            transition: 0.3s; border: 1px solid rgba(255,255,255,0.05); position: relative; overflow: hidden;
        }
        .admin-tile:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--glow); }
        .admin-tile h3 { font-size: 1.5rem; margin: 10px 0; color: white; }
        .admin-tile p { color: var(--text-muted); margin: 0; font-size: 0.9rem; }
        .admin-tile::before { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 4px; background: linear-gradient(to right, var(--primary), var(--secondary)); }

        .search-container { position: relative; max-width: 500px; margin: 0 auto 25px; }
        .search-container input { width: 100%; background: var(--bg-card); border: 2px solid #334155; padding: 12px 20px; border-radius: 50px; color: white; text-align: center; font-size: 1rem; transition: 0.3s; }
        .search-container input:focus { border-color: var(--secondary); box-shadow: 0 0 15px rgba(139, 92, 246, 0.2); }

        /* --- Table --- */
        .table-wrapper { background: var(--bg-card); border-radius: 16px; padding: 20px; box-shadow: var(--shadow); overflow-x: auto; border: 1px solid rgba(255,255,255,0.05); }
        table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
        th { color: var(--text-muted); font-size: 0.85rem; padding: 10px; font-weight: 600; text-align: center; }
        td { background: #263346; padding: 15px; text-align: center; font-size: 0.95rem; vertical-align: middle; border-top: 1px solid transparent; border-bottom: 1px solid transparent; }
        td:first-child { border-top-right-radius: 10px; border-bottom-right-radius: 10px; }
        td:last-child { border-top-left-radius: 10px; border-bottom-left-radius: 10px; }
        tr:hover td { background: var(--bg-hover); transition: 0.2s; }

        @media (max-width: 768px) {
            .table-wrapper { background: transparent; padding: 0; box-shadow: none; overflow: visible; }
            table, thead, tbody, th, td, tr { display: block; }
            thead tr { position: absolute; top: -9999px; left: -9999px; }
            tr { 
                background: var(--bg-card); margin-bottom: 15px; border-radius: 12px; 
                padding: 15px; border: 1px solid rgba(255,255,255,0.05);
                box-shadow: 0 4px 6px rgba(0,0,0,0.2);
            }
            td { 
                border: none; background: transparent; padding: 8px 0; text-align: left; 
                display: flex; justify-content: space-between; align-items: center;
                border-bottom: 1px solid rgba(255,255,255,0.05);
            }
            td:last-child { border-bottom: none; display: flex; justify-content: center; flex-wrap: wrap; gap: 5px; margin-top: 10px; }
            td:first-child { border-radius: 0; }
            td::before {
                content: attr(data-label);
                color: var(--text-muted); font-weight: bold; font-size: 0.85rem;
            }
            tr:hover td { background: transparent; }
        }

        .badge { padding: 5px 10px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; display: inline-block; }
        .badge-active { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid rgba(16, 185, 129, 0.3); }
        .badge-expired { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.3); }
        .badge-blocked { background: rgba(245, 158, 11, 0.2); color: var(--warning); border: 1px solid rgba(245, 158, 11, 0.3); }
        .code-text { font-family: monospace; color: var(--secondary); font-weight: bold; font-size: 1.1rem; letter-spacing: 1px; }

        /* --- Modals & Toasts --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(5px);
            display: none; justify-content: center; align-items: center; z-index: 9999; animation: fadeIn 0.2s;
        }
        .modal-content { background: #1e293b; padding: 30px; border-radius: 20px; width: 95%; max-width: 450px; border: 1px solid rgba(255,255,255,0.1); box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5); }
        .modal-content h3 { text-align: center; color: var(--text-main); margin-top: 0; }
        .modal-content select, .modal-content input, .modal-content textarea { width: 100%; padding: 12px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; }
        
        #toast-container { position: fixed; bottom: 30px; left: 30px; z-index: 10000; display: flex; flex-direction: column; gap: 10px; }
        .toast { padding: 15px 25px; border-radius: 12px; color: #fff; font-weight: bold; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3); display: flex; align-items: center; gap: 10px; animation: slideUp 0.3s ease-out; }
        .toast-success { background: linear-gradient(to right, #059669, #10b981); }
        .toast-error { background: linear-gradient(to right, #dc2626, #ef4444); }
        .toast-warn { background: linear-gradient(to right, #d97706, #f59e0b); }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    </style>
</head>
<body>

<script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
    import { getDatabase, ref, onValue, update, remove, set, push } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js'; 

    const firebaseConfig = {
        apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g",
        authDomain: "thanawy-1383.firebaseapp.com",
        databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
        projectId: "thanawy-1383",
        storageBucket: "thanawy-1383.firebasestorage.app",
        messagingSenderId: "1026664406457",
        appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
        measurementId: "G-J5R2EFM2D0"
    };
    
    const CURRENT_ADMIN_ROLE = 'giza'; 
    const GIZA_ALLOWED_UID = "MeGkUlBKCuas45rXQSX0DheNBBy1"; 
    
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    
    const codesRef = ref(db, 'approvedStudents');
    const blockedDevicesRef = ref(db, 'blockedDevices');
    const expensesRef = ref(db, 'expenses'); // Ù…Ø±Ø¬Ø¹ Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ù…ØµØ§Ø±ÙŠÙ

    let allCodesData = {};
    let allBlockedDevices = {};
    let allExpenses = {};
    let activeTile = null; 
    let currentUserUid = null; 
    let currentCategorizedData = { active: [], manuallyBlocked: [], expired: [] }; 
    let currentSearchQuery = ""; 

    window.showToast = (message, type = "success") => {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        let icon = type === 'success' ? 'check-circle' : (type === 'error' ? 'times-circle' : 'exclamation-circle');
        toast.className = `toast toast-${type}`;
        toast.innerHTML = `<i class="fas fa-${icon}"></i> ${message}`;
        container.appendChild(toast);
        setTimeout(() => { 
            toast.style.opacity = '0'; 
            toast.style.transform = 'translateY(10px)'; 
            setTimeout(() => toast.remove(), 300);
        }, 4000);
    };

    window.copyCode = (code) => {
        navigator.clipboard.writeText(code).then(() => {
            window.showToast(`ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯: ${code}`, "success");
        });
    }

    window.copyNewCode = () => {
        const code = document.getElementById('newCodeDisplay').textContent;
        navigator.clipboard.writeText(code).then(() => {
            window.showToast("âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯");
        });
    }
    
    async function checkAdminStatus(uid) {
        if (uid === GIZA_ALLOWED_UID) return true;
        window.showToast("âŒ ØºÙŠØ± Ù…ÙØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„.", "error");
        signOut(auth); 
        return false;
    }
    
    async function checkAuthAndProceed(action, ...args) {
        if (!currentUserUid) { window.showToast("âŒ Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„ Ø§Ù„Ø£ÙˆÙ„ ÙŠØ§ Ø¨Ø·Ù„.", "error"); return; }
        if (await checkAdminStatus(currentUserUid)) { action(...args); }
    }

    window.handleLogin = async (e) => {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const btn = e.target.querySelector('button');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¯Ø®ÙˆÙ„...';
        
        try {
            const userCredential = await signInWithEmailAndPassword(auth, email, password);
            if (await checkAdminStatus(userCredential.user.uid)) { 
                currentUserUid = userCredential.user.uid;
                document.getElementById('loginContainer').style.display = 'none';
                document.getElementById('mainContent').style.display = 'block';
                loadAllCodes(); 
                window.showToast("ğŸ”“ Ø£Ù‡Ù„Ø§Ù‹ Ø¨ÙŠÙƒ ÙŠØ§ Ù…Ù„Ùƒ Ø§Ù„Ù„ÙˆØ­Ø©", "success");
            } 
        } catch (error) { window.showToast(`âŒ Ø®Ø·Ø£: ${error.message}`, "error"); }
        finally { btn.innerHTML = originalText; }
    };

    window.logout = async () => { await signOut(auth); window.location.reload(); };

    function generateUniqueCode() {
        let code;
        do { code = String(Math.floor(100000 + Math.random() * 900000)); } while (allCodesData[code]);
        return code;
    }

    window.handleSearch = (query) => {
        currentSearchQuery = query.toLowerCase().trim();
        if (activeTile && !activeTile.startsWith('BLOCKED') && !activeTile.startsWith('COLLECTION')) {
            const titleNode = document.querySelector('#codeDetailsContainer h2');
            if (titleNode) {
                const title = titleNode.innerText;
                let categoryKey = 'active';
                if (title.includes('Ø§Ù„Ù…ÙØ¹Ø·Ù„Ø©')) categoryKey = 'manuallyBlocked';
                if (title.includes('Ù…ÙÙ†ØªÙ‡ÙŠØ©')) categoryKey = 'expired';
                renderFilteredCodesTable(activeTile, categoryKey, title.split(' Ù„Ù€ ')[0], false);
            }
        }
    };

    window.toggleBlock = (uid, name, isBlocked) => checkAuthAndProceed(() => {
        update(ref(db, 'approvedStudents/' + uid), { isBlocked: !isBlocked })
        .then(() => window.showToast(`âœ… ØªÙ… ${!isBlocked ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'} ${name}`, "warn"));
    });

    window.ejectDevice = (uid, name) => checkAuthAndProceed(() => {
        if (!confirm(`Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø·Ø±Ø¯ Ø¬Ù‡Ø§Ø² Ø§Ù„Ø·Ø§Ù„Ø¨ ${name}ØŸ`)) return;
        update(ref(db, 'approvedStudents/' + uid), { deviceId: "" })
        .then(() => window.showToast(`ğŸ‘¢ ØªÙ… Ø·Ø±Ø¯ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­`, "success"));
    });

    window.deleteCode = (uid, name) => checkAuthAndProceed(() => {
        if (!confirm(`âš ï¸ ØªØ­Ø°ÙŠØ±: Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨ ${name}ØŸ Ù„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ØªØ±Ø§Ø¬Ø¹!`)) return;
        remove(ref(db, 'approvedStudents/' + uid))
        .then(() => window.showToast("ğŸ—‘ï¸ ØªÙ… Ø§Ù„Ø­Ø°Ù", "error"));
    });

    window.openEditModal = (uid) => {
        const data = allCodesData[uid];
        if (!data) return;
        document.getElementById('editUid').value = uid;
        document.getElementById('editName').value = data.name;
        document.getElementById('editSection').value = data.section || "";
        document.getElementById('editPrice').value = data.pricePaid || 0;
        document.getElementById('editModalOverlay').style.display = 'flex';
    };

    window.closeEditModal = () => { document.getElementById('editModalOverlay').style.display = 'none'; };

    window.saveEditedDetails = (e) => {
        e.preventDefault();
        const uid = document.getElementById('editUid').value;
        update(ref(db, 'approvedStudents/' + uid), {
            name: document.getElementById('editName').value,
            section: document.getElementById('editSection').value,
            pricePaid: parseFloat(document.getElementById('editPrice').value) || 0
        }).then(() => {
            window.showToast("âœ… ØªÙ… Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª");
            closeEditModal();
        });
    };

    window.addNewCode = (e) => checkAuthAndProceed(() => {
        e.preventDefault();
        const form = e.target;
        const newCode = document.getElementById('newCodeDisplay').textContent;
        let expiryTime = Date.now();
        if (form.durationType.value === 'trial') expiryTime += 3600000;
        else if (form.durationType.value === '30days') expiryTime += 2592000000;
        else expiryTime += (parseInt(form.customDays.value) || 0) * 86400000;

        set(ref(db, 'approvedStudents/' + newCode), {
            uid: newCode, name: form.studentName.value, section: form.studentSection.value,
            pricePaid: parseFloat(form.price.value) || 0, addedByAdmin: CURRENT_ADMIN_ROLE,
            approvedAt: Date.now(), expiry: expiryTime, deviceId: "", isBlocked: false
        }).then(() => {
            window.showToast("ğŸ‰ ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¯ Ø¨Ù†Ø¬Ø§Ø­!");
            toggleAddCodeForm(false);
            form.reset();
        });
    });

    window.renewCode = (uid, name) => checkAuthAndProceed(() => {
        const days = parseInt(prompt(`ÙƒÙ… Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù„Ù€ ${name}?`));
        if (isNaN(days)) return;
        const current = allCodesData[uid];
        let newExpiry = (current.expiry < Date.now()) ? Date.now() + (days * 86400000) : current.expiry + (days * 86400000);
        update(ref(db, 'approvedStudents/' + uid), { expiry: newExpiry, isBlocked: false })
        .then(() => window.showToast("âœ… ØªÙ… Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ø¨Ù†Ø¬Ø§Ø­"));
    });

    window.addBlockedDevicePrompt = (id) => checkAuthAndProceed(() => {
        const notes = prompt("Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„Ø­Ø¸Ø±:") || "Ø­Ø¸Ø± ÙŠØ¯ÙˆÙŠ";
        set(ref(db, 'blockedDevices/' + id.trim()), {
            deviceId: id.trim(), blockedBy: CURRENT_ADMIN_ROLE, timestamp: Date.now(), notes: notes
        }).then(() => window.showToast("â›” ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¨Ù†Ø¬Ø§Ø­", "error"));
    });

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ ---
    window.toggleExpenseForm = (show) => {
        document.getElementById('addExpenseOverlay').style.display = show ? 'flex' : 'none';
    };

    window.handleAddExpense = (e) => checkAuthAndProceed(() => {
        e.preventDefault();
        const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
        const reason = document.getElementById('expenseReason').value;
        if(amount <= 0) return window.showToast("âŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­", "error");

        push(expensesRef, {
            amount: amount,
            reason: reason,
            addedBy: CURRENT_ADMIN_ROLE,
            timestamp: Date.now()
        }).then(() => {
            window.showToast("ğŸ’¸ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ", "warn");
            toggleExpenseForm(false);
            document.getElementById('expenseForm').reset();
        });
    });

    window.deleteExpense = (id) => checkAuthAndProceed(() => {
        if(!confirm("Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ")) return;
        remove(ref(db, `expenses/${id}`)).then(() => window.showToast("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ"));
    });

    function loadAllCodes() {
        onValue(codesRef, (snap) => {
            allCodesData = snap.val() || {};
            if (activeTile && activeTile !== 'COLLECTION') {
                if (activeTile === 'BLOCKED_DEVICES') window.toggleBlockedDevicesDetails();
                else if (!activeTile.startsWith('BLOCKED')) window.toggleAdminDetails(activeTile, true);
            }
            if (activeTile === 'COLLECTION') window.toggleCollectionDetails(); // Refresh collection if active
        });
        onValue(blockedDevicesRef, (snap) => {
            allBlockedDevices = snap.val() || {};
            if (activeTile === 'BLOCKED_DEVICES') window.toggleBlockedDevicesDetails('TOTAL', true);
        });
        onValue(expensesRef, (snap) => {
            allExpenses = snap.val() || {};
            if (activeTile === 'COLLECTION') window.toggleCollectionDetails(); // Refresh calculation
        });
    }

    onAuthStateChanged(auth, (user) => {
        if (user && user.uid === GIZA_ALLOWED_UID) {
            currentUserUid = user.uid;
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            loadAllCodes();
        } else {
            document.getElementById('loginContainer').style.display = 'block';
            document.getElementById('mainContent').style.display = 'none';
        }
    });

    function formatExpiry(timestamp) {
        const diff = timestamp - Date.now();
        if (diff < 0) return '<span class="badge badge-expired">Ù…Ù†ØªÙ‡ÙŠ</span>';
        const days = Math.floor(diff / 86400000);
        const hours = Math.floor((diff % 86400000) / 3600000);
        return `<span style="font-weight:bold; color:var(--text-main)">${days}ÙŠ ${hours}Ø³</span>`;
    }

    window.renderFilteredCodesTable = (adminRole, categoryKey, categoryName, resetSearch = true) => {
        if (resetSearch) currentSearchQuery = "";
        const codes = (adminRole === 'TOTAL' ? Object.values(allCodesData) : Object.values(allCodesData).filter(c => (c.addedByAdmin || 'giza').toLowerCase() === adminRole.toLowerCase()));
        const now = Date.now();
        window.currentCategorizedData = codes.reduce((acc, c) => {
            if (c.expiry < now) acc.expired.push(c);
            else if (c.isBlocked) acc.manuallyBlocked.push(c);
            else acc.active.push(c);
            return acc;
        }, { active: [], manuallyBlocked: [], expired: [] });

        let filtered = window.currentCategorizedData[categoryKey] || [];
        if (currentSearchQuery) {
            filtered = filtered.filter(c => c.uid.toLowerCase().includes(currentSearchQuery) || (c.name && c.name.toLowerCase().includes(currentSearchQuery)));
        }

        const container = document.getElementById('codeDetailsContainer');
        if(!document.getElementById('searchBox') || resetSearch) {
             container.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                    <button class="action-btn" style="background:var(--bg-hover); color:white; padding:10px 20px;" onclick="toggleAdminDetails('${adminRole}', true)">
                        <i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹
                    </button>
                    <h2 style="color:var(--text-main); margin:0;">${categoryName} <span style="font-size:0.8em; color:var(--primary)">(${filtered.length})</span></h2>
                    <div style="width:80px;"></div>
                </div>
                <div class="search-container"><input type="text" id="searchBox" placeholder="ğŸ” Ø§Ø¨Ø­Ø« Ø¨Ø§Ù„Ø§Ø³Ù… Ø£Ùˆ Ø§Ù„ÙƒÙˆØ¯..." oninput="handleSearch(this.value)" value="${currentSearchQuery}" autofocus></div>
                <div class="table-wrapper">
                    <table><thead><tr><th>Ø§Ù„ÙƒÙˆØ¯</th><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø´Ø¹Ø¨Ø©</th><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>ID Ø§Ù„Ø¬Ù‡Ø§Ø²</th><th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead><tbody></tbody></table>
                </div>`;
        }

        const tbody = container.querySelector('tbody');
        tbody.innerHTML = '';
        if (filtered.length === 0) { tbody.innerHTML = '<tr><td colspan="8" style="padding:30px; color:var(--text-muted);">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ø¹Ø±Ø¶Ù‡Ø§ ğŸ“­</td></tr>'; return; }

        filtered.forEach(d => {
            const tr = document.createElement('tr');
            let statusBadge = d.expiry < now ? '<span class="badge badge-expired">Ù…Ù†ØªÙ‡ÙŠ</span>' : (d.isBlocked ? '<span class="badge badge-blocked">Ù…Ø¹Ø·Ù„</span>' : '<span class="badge badge-active">Ù†Ø´Ø·</span>');
            tr.innerHTML = `
                <td data-label="Ø§Ù„ÙƒÙˆØ¯"><span class="code-text">${d.uid}</span><button class="btn-copy-code" onclick="copyCode('${d.uid}')" title="Ù†Ø³Ø®"><i class="fas fa-copy"></i></button></td>
                <td data-label="Ø§Ù„Ø§Ø³Ù…" style="font-weight:600;">${d.name}</td><td data-label="Ø§Ù„Ø´Ø¹Ø¨Ø©">${d.section || '-'}</td>
                <td data-label="Ø§Ù„Ù…Ø¨Ù„Øº" style="color:var(--success); font-weight:bold;">${d.pricePaid} Ø¬.Ù…</td><td data-label="Ø§Ù„Ù…Ø¯Ø©">${formatExpiry(d.expiry)}</td>
                <td data-label="Ø§Ù„Ø­Ø§Ù„Ø©">${statusBadge}</td><td data-label="ID Ø§Ù„Ø¬Ù‡Ø§Ø²" style="font-size:0.8rem; color:#aaa;">${d.deviceId ? d.deviceId.substring(0, 10) + '...' : '<span style="opacity:0.3">--</span>'}</td>
                <td data-label="Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª" class="actions">
                    <button onclick="openEditModal('${d.uid}')" class="action-btn btn-edit"><i class="fas fa-edit"></i></button>
                    ${d.deviceId ? `<button onclick="addBlockedDevicePrompt('${d.deviceId}')" class="action-btn btn-block"><i class="fas fa-ban"></i></button>` : ''}
                    <button onclick="ejectDevice('${d.uid}', '${d.name}')" class="action-btn btn-eject"><i class="fas fa-sign-out-alt"></i></button>
                    <button onclick="toggleBlock('${d.uid}', '${d.name}', ${d.isBlocked})" class="action-btn btn-block"><i class="fas ${d.isBlocked ? 'fa-play' : 'fa-pause'}"></i></button>
                    ${categoryKey === 'expired' ? `<button onclick="renewCode('${d.uid}', '${d.name}')" class="action-btn btn-edit"><i class="fas fa-sync"></i></button>` : ''}
                    <button onclick="deleteCode('${d.uid}', '${d.name}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button>
                </td>`;
            tbody.appendChild(tr);
        });
        const searchInput = document.getElementById('searchBox');
        if(searchInput) { searchInput.focus(); const val = searchInput.value; searchInput.value = ''; searchInput.value = val; }
    };

    window.toggleAdminDetails = (role, force = false) => {
        activeTile = role;
        const container = document.getElementById('codeDetailsContainer');
        const codes = (role === 'TOTAL' ? Object.values(allCodesData) : Object.values(allCodesData).filter(c => (c.addedByAdmin || 'giza').toLowerCase() === role.toLowerCase()));
        const now = Date.now();
        const cat = codes.reduce((acc, c) => {
            if (c.expiry < now) acc.expired.push(c);
            else if (c.isBlocked) acc.manuallyBlocked.push(c);
            else acc.active.push(c);
            return acc;
        }, { active: [], manuallyBlocked: [], expired: [] });
        window.currentCategorizedData = cat;
        
        container.innerHTML = `
            <h2 style="text-align:center; margin-bottom:20px;">Ø¥Ø¯Ø§Ø±Ø©: <span style="color:var(--primary)">${role}</span></h2>
            <div class="admin-tiles sub-tiles-container">
                <div class="admin-tile" onclick="renderFilteredCodesTable('${role}', 'active', 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù†Ø´Ø·Ø©')"><i class="fas fa-user-check fa-2x" style="color:var(--success); margin-bottom:10px;"></i><h3>${cat.active.length}</h3><p>Ø·Ø§Ù„Ø¨ Ù†Ø´Ø·</p></div>
                <div class="admin-tile" style="border-bottom: 4px solid var(--warning);" onclick="renderFilteredCodesTable('${role}', 'manuallyBlocked', 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ø·Ù„Ø©')"><i class="fas fa-user-lock fa-2x" style="color:var(--warning); margin-bottom:10px;"></i><h3>${cat.manuallyBlocked.length}</h3><p>Ù…Ø¹Ø·Ù„ ÙŠØ¯ÙˆÙŠØ§Ù‹</p></div>
                <div class="admin-tile" style="border-bottom: 4px solid var(--danger);" onclick="renderFilteredCodesTable('${role}', 'expired', 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©')"><i class="fas fa-user-times fa-2x" style="color:var(--danger); margin-bottom:10px;"></i><h3>${cat.expired.length}</h3><p>Ø§Ø´ØªØ±Ø§Ùƒ Ù…Ù†ØªÙ‡ÙŠ</p></div>
            </div>`;
    };

    window.toggleBlockedDevicesDetails = () => {
        activeTile = 'BLOCKED_DEVICES';
        const container = document.getElementById('codeDetailsContainer');
        const devices = Object.values(allBlockedDevices);
        container.innerHTML = `
            <h2 style="color:var(--danger); text-align:center; margin-bottom:20px;"><i class="fas fa-ban"></i> Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© (${devices.length})</h2>
            <div class="table-wrapper">
                <table><thead><tr><th>Ù…Ø¹Ø±Ù Ø§Ù„Ø¬Ù‡Ø§Ø² (Device ID)</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th><th>Ø¥Ø¬Ø±Ø§Ø¡</th></tr></thead>
                <tbody>${devices.map(d => `<tr><td data-label="ID Ø§Ù„Ø¬Ù‡Ø§Ø²" style="font-family:monospace; color:var(--text-muted);">${d.deviceId}</td><td data-label="Ø¨ÙˆØ§Ø³Ø·Ø©">${d.blockedBy}</td><td data-label="Ù…Ù„Ø§Ø­Ø¸Ø§Øª">${d.notes}</td><td data-label="Ø¥Ø¬Ø±Ø§Ø¡"><button onclick="unblockDevice('${d.deviceId}')" class="action-btn btn-success" style="background:var(--success); color:white;">ÙÙƒ Ø§Ù„Ø­Ø¸Ø±</button></td></tr>`).join('')}</tbody></table>
            </div>`;
    };

    // ğŸ”¥ Ù‚Ø³Ù… Ø§Ù„Ù…Ø§Ù„ÙŠØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ ğŸ”¥
    window.toggleCollectionDetails = () => {
        activeTile = 'COLLECTION';
        const container = document.getElementById('codeDetailsContainer');
        const data = Object.values(allCodesData);
        const expenseList = Object.entries(allExpenses).map(([key, val]) => ({id: key, ...val})).sort((a,b) => b.timestamp - a.timestamp);
        
        const calcIncome = (admin) => data.filter(c => (c.addedByAdmin || 'giza').toLowerCase() === admin).reduce((sum, c) => sum + (parseFloat(c.pricePaid) || 0), 0);
        const totalIncome = data.reduce((sum, c) => sum + (parseFloat(c.pricePaid) || 0), 0);
        const totalExpenses = expenseList.reduce((sum, e) => sum + (parseFloat(e.amount) || 0), 0);
        const netProfit = totalIncome - totalExpenses;

        container.innerHTML = `
            <h2 style="color:var(--secondary); text-align:center; margin-bottom:20px;">ğŸ’° Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø§Ù„ÙŠ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
            
            <div class="admin-tiles">
                <div class="admin-tile" style="background: linear-gradient(135deg, #10b981, #059669); border:none;">
                    <i class="fas fa-coins fa-2x" style="color:white; margin-bottom:10px;"></i>
                    <h3 style="color:white;">${totalIncome.toLocaleString()} Ø¬.Ù…</h3>
                    <p style="color:white; opacity:0.9;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¯Ø®Ù„</p>
                </div>
                <div class="admin-tile" style="background: linear-gradient(135deg, #ef4444, #dc2626); border:none;">
                    <i class="fas fa-file-invoice-dollar fa-2x" style="color:white; margin-bottom:10px;"></i>
                    <h3 style="color:white;">${totalExpenses.toLocaleString()} Ø¬.Ù…</h3>
                    <p style="color:white; opacity:0.9;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</p>
                </div>
                <div class="admin-tile" style="background: linear-gradient(135deg, #f59e0b, #d97706); border:none; box-shadow: 0 0 20px rgba(245, 158, 11, 0.4);">
                    <i class="fas fa-piggy-bank fa-2x" style="color:white; margin-bottom:10px;"></i>
                    <h3 style="color:white;">${netProfit.toLocaleString()} Ø¬.Ù…</h3>
                    <p style="color:white; opacity:0.9; font-weight:bold;">Ø§Ù„Ø±Ø¨Ø­ Ø§Ù„ØµØ§ÙÙŠ</p>
                </div>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:15px; margin-bottom:30px;">
                <div style="background:#263346; padding:15px; border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.05);">
                    <span style="color:#ec4899; font-weight:bold;">Ø³Ø§Ø±Ø©:</span> ${calcIncome('sara').toLocaleString()} Ø¬.Ù…
                </div>
                <div style="background:#263346; padding:15px; border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.05);">
                    <span style="color:#8b5cf6; font-weight:bold;">Ø§Ù„Ø¬ÙŠØ²Ø©:</span> ${calcIncome('giza').toLocaleString()} Ø¬.Ù…
                </div>
            </div>

            <div style="background:var(--bg-card); padding:20px; border-radius:15px; border:1px solid rgba(255,255,255,0.05);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="margin:0; color:var(--danger);">ğŸ”» Ø³Ø¬Ù„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ</h3>
                    <button class="action-btn" onclick="toggleExpenseForm(true)" style="background:var(--danger); color:white; font-weight:bold;">+ Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
                </div>
                <div class="table-wrapper">
                    <table>
                        <thead><tr><th>Ø§Ù„Ù…Ø¨Ù„Øº</th><th>Ø§Ù„Ø³Ø¨Ø¨ / Ø§Ù„Ø¨Ù†Ø¯</th><th>Ø¨ÙˆØ§Ø³Ø·Ø©</th><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø­Ø°Ù</th></tr></thead>
                        <tbody>
                            ${expenseList.length ? expenseList.map(e => `
                            <tr>
                                <td style="color:var(--danger); font-weight:bold;">-${e.amount}</td>
                                <td>${e.reason}</td>
                                <td>${e.addedBy}</td>
                                <td style="direction:ltr;">${new Date(e.timestamp).toLocaleDateString('ar-EG')}</td>
                                <td><button onclick="deleteExpense('${e.id}')" class="action-btn btn-delete"><i class="fas fa-trash"></i></button></td>
                            </tr>`).join('') : '<tr><td colspan="5" style="text-align:center; padding:20px; color:#aaa;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù…Ø³Ø¬Ù„Ø© ğŸ‘Œ</td></tr>'}
                        </tbody>
                    </table>
                </div>
            </div>`;
    };

    window.unblockDevice = (id) => remove(ref(db, 'blockedDevices/' + id));
    window.toggleAddCodeForm = (s) => { 
        const form = document.getElementById('addCodeFormContainer');
        if(s) { form.style.display = 'block'; document.getElementById('newCodeDisplay').textContent = generateUniqueCode(); } 
        else { form.style.display = 'none'; }
    };
    window.copyDeviceID = (id) => { navigator.clipboard.writeText(id).then(() => window.showToast("âœ… ØªÙ… Ø§Ù„Ù†Ø³Ø®")); };
</script>

<div class="container">
    <div id="loginContainer">
        <h2>ELGIZAWY PANEL ğŸš€</h2>
        <form onsubmit="handleLogin(event)">
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
            <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            <button type="submit" class="btn-primary" style="width:100%; border-radius:10px;">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        </form>
    </div>

    <div id="mainContent" style="display:none;">
        <header>
            <h1>ELGIZAWY <span style="font-size:0.6em; opacity:0.7; color:white;">| Control Panel</span></h1>
            <button onclick="logout()" class="btn-logout"><i class="fas fa-sign-out-alt"></i> Ø®Ø±ÙˆØ¬</button>
        </header>

        <button class="btn-primary" onclick="toggleAddCodeForm(true)">
            <i class="fas fa-plus-circle"></i> Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨ Ø¬Ø¯ÙŠØ¯
        </button>

        <div id="addCodeFormContainer" class="modal-overlay">
            <div class="modal-content">
                <h3 style="color:var(--primary); margin-bottom:5px;">Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯</h3>
                <div style="display:flex; justify-content:center; align-items:center; gap:10px; margin:10px 0;">
                    <p style="text-align:center; font-size:1.5rem; letter-spacing:2px; color:white; font-weight:bold; margin:0;" id="newCodeDisplay">------</p>
                    <button type="button" onclick="copyNewCode()" class="action-btn" style="background:var(--secondary); color:white; border-radius:5px;" title="Ù†Ø³Ø® Ø§Ù„ÙƒÙˆØ¯"><i class="fas fa-copy"></i></button>
                </div>
                <form onsubmit="addNewCode(event)">
                    <input type="text" name="studentName" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø§Ù„Ø«Ù„Ø§Ø«ÙŠ" required>
                    <select name="studentSection" required>
                        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø´Ø¹Ø¨Ø©</option><option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option><option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option><option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option><option value="Ø£Ø²Ù‡Ø±">Ø£Ø²Ù‡Ø±</option>
                    </select>
                    <input type="number" name="price" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ù†ÙŠØ©)">
                    <select name="durationType"><option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©)</option><option value="30days" selected>Ø§Ø´ØªØ±Ø§Ùƒ Ø´Ù‡Ø±ÙŠ (30 ÙŠÙˆÙ…)</option><option value="custom">Ù…Ø¯Ø© Ù…Ø®ØµØµØ©</option></select>
                    <input type="number" name="customDays" placeholder="Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… (ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®ØµØµ)">
                    <div style="display:flex; gap:10px; margin-top:20px;">
                        <button type="submit" class="btn-primary" style="margin:0; width:100%; border-radius:8px;">Ø­ÙØ¸ ÙˆØªÙØ¹ÙŠÙ„</button>
                        <button type="button" onclick="toggleAddCodeForm(false)" style="background:var(--bg-hover); color:white; border-radius:8px; padding:0 20px;">Ø¥Ù„ØºØ§Ø¡</button>
                    </div>
                </form>
            </div>
        </div>

        <div class="admin-tiles">
            <div class="admin-tile" onclick="toggleAdminDetails('sara')"><i class="fas fa-user-tie fa-2x" style="color:#ec4899; margin-bottom:15px;"></i><h3>Sara</h3><p>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø³Ø§Ø±Ø©</p></div>
            <div class="admin-tile" onclick="toggleAdminDetails('giza')"><i class="fas fa-user-shield fa-2x" style="color:#8b5cf6; margin-bottom:15px;"></i><h3>GIZA</h3><p>Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©</p></div>
            <div class="admin-tile" onclick="toggleBlockedDevicesDetails()"><i class="fas fa-ban fa-2x" style="color:var(--danger); margin-bottom:15px;"></i><h3 style="color:var(--danger)">Ø§Ù„Ø­Ø¸Ø±</h3><p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</p></div>
            <div class="admin-tile" onclick="toggleCollectionDetails()"><i class="fas fa-chart-line fa-2x" style="color:var(--success); margin-bottom:15px;"></i><h3 style="color:var(--success)">Ø§Ù„Ù…Ø§Ù„ÙŠØ©</h3><p>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ø±Ø¨Ø§Ø­ ÙˆØ§Ù„Ù…ØµØ§Ø±ÙŠÙ</p></div>
            <div class="admin-tile" onclick="toggleAdminDetails('TOTAL')"><i class="fas fa-users fa-2x" style="color:var(--text-main); margin-bottom:15px;"></i><h3>Ø§Ù„ÙƒÙ„</h3><p>Ø¹Ø±Ø¶ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨</p></div>
        </div>

        <div id="codeDetailsContainer" style="margin-bottom: 50px;">
            <div style="text-align:center; padding:40px; color:var(--text-muted); border: 2px dashed #334155; border-radius:20px;">
                <i class="fas fa-mouse-pointer fa-3x" style="margin-bottom:20px; opacity:0.5;"></i><p>Ø§Ø®ØªØ± Ù‚Ø³Ù…Ø§Ù‹ Ù…Ù† Ø§Ù„Ø£Ø¹Ù„Ù‰ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</p>
            </div>
        </div>
    </div>
</div>

<div id="editModalOverlay" class="modal-overlay">
    <div class="modal-content">
        <h3><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨</h3>
        <form onsubmit="saveEditedDetails(event)">
            <input type="hidden" id="editUid">
            <label style="font-size:0.9rem; color:var(--text-muted);">Ø§Ù„Ø§Ø³Ù…:</label><input type="text" id="editName" placeholder="Ø§Ù„Ø§Ø³Ù…" required>
            <label style="font-size:0.9rem; color:var(--text-muted);">Ø§Ù„Ø´Ø¹Ø¨Ø©:</label>
            <select id="editSection"><option value="Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…">Ø¹Ù„Ù…ÙŠ Ø¹Ù„ÙˆÙ…</option><option value="Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©">Ø¹Ù„Ù…ÙŠ Ø±ÙŠØ§Ø¶Ø©</option><option value="Ø£Ø¯Ø¨ÙŠ">Ø£Ø¯Ø¨ÙŠ</option><option value="Ø£Ø²Ù‡Ø±">Ø£Ø²Ù‡Ø±</option></select>
            <label style="font-size:0.9rem; color:var(--text-muted);">Ø§Ù„Ù…Ø¨Ù„Øº:</label><input type="number" id="editPrice" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn-primary" style="margin:0; width:100%; border-radius:8px;">Ø­ÙØ¸ Ø§Ù„ØªØºÙŠÙŠØ±Ø§Øª</button>
                <button type="button" onclick="closeEditModal()" style="background:var(--bg-hover); color:white; border-radius:8px; padding:0 20px;">Ø¥ØºÙ„Ø§Ù‚</button>
            </div>
        </form>
    </div>
</div>

<div id="addExpenseOverlay" class="modal-overlay">
    <div class="modal-content">
        <h3 style="color:var(--danger);"><i class="fas fa-file-invoice-dollar"></i> ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h3>
        <form id="expenseForm" onsubmit="handleAddExpense(event)">
            <label style="font-size:0.9rem; color:var(--text-muted);">Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…Ø¨Ù„Øº:</label>
            <input type="number" id="expenseAmount" placeholder="Ù…Ø«Ù„Ø§Ù‹: 200" required>
            <label style="font-size:0.9rem; color:var(--text-muted);">Ø³Ø¨Ø¨ Ø§Ù„ØµØ±Ù (Ø§Ù„Ø¨Ù†Ø¯):</label>
            <input type="text" id="expenseReason" placeholder="Ù…Ø«Ù„Ø§Ù‹: ØµÙŠØ§Ù†Ø© Ø³ÙŠØ±ÙØ±ØŒ Ø¥ÙŠØ¬Ø§Ø±..." required>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <button type="submit" class="btn-primary" style="margin:0; width:100%; border-radius:8px; background:var(--danger);">ØªØ³Ø¬ÙŠÙ„ Ø®ØµÙ…</button>
                <button type="button" onclick="toggleExpenseForm(false)" style="background:var(--bg-hover); color:white; border-radius:8px; padding:0 20px;">Ø¥Ù„ØºØ§Ø¡</button>
            </div>
        </form>
    </div>
</div>

<div id="toast-container"></div>
</body>
</html>
