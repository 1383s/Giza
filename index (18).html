<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GIZA - Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…Ø§Ù„Ùƒ ğŸ‘‘ | Full Mark</title>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-app.js';
        import { getDatabase, ref, onValue, update, remove, set } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-database.js';
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from 'https://www.gstatic.com/firebasejs/10.1.0/firebase-auth.js'; 

        // ğŸš¨ Ø¨Ø±Ø¬Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ 
        const firebaseConfig = {
            apiKey: "AIzaSyBK6FZF3LW83qaUHBKYTfiVd2Ozrd1Rf2g", // âœ… ØªØ­Ø¯ÙŠØ«
            authDomain: "thanawy-1383.firebaseapp.com",
            databaseURL: "https://thanawy-1383-default-rtdb.firebaseio.com",
            projectId: "thanawy-1383",
            storageBucket: "thanawy-1383.firebasestorage.app",
            messagingSenderId: "1026664406457",
            appId: "1:1026664406457:web:87d71f7e41bef36ba0aa68",
            measurementId: "G-J5R2EFM2D0"
        };
        
        // ğŸ”‘ ØªØ­Ø¯ÙŠØ¯ Ø¯ÙˆØ± Ø§Ù„Ù„ÙˆØ­Ø© Ø¯ÙŠ
        const CURRENT_ADMIN_ROLE = 'giza'; 

        // ğŸš¨ğŸš¨ğŸš¨ Ù‡Ø°Ø§ Ø§Ù„Ù€ UID ÙŠØ¬Ø¨ Ø£Ù† ÙŠØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡ Ø¨Ø§Ù„Ù€ UID Ø§Ù„Ø®Ø§Øµ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø§Ù„Ùƒ (GIZA) ÙÙŠ Firebase Auth
        const GIZA_ALLOWED_UID = "MeGkUlBKCuas45rXQSX0DheNBBy1"; 
        
        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);
        
        // Ù…Ø³Ø§Ø±Ø§Øª Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        const codesRef = ref(db, 'approvedStudents');
        const blockedDevicesRef = ref(db, 'blockedDevices'); // Ù…Ø³Ø§Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©

        
        let allCodesData = {};
        let allBlockedDevices = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
        let activeTile = null; 
        let currentUserUid = null; 
        let currentCategorizedData = { active: [], manuallyBlocked: [], expired: [] }; 
        
        
        // ğŸ¨ Global UI Functions
        window.showToast = (message, type = "success") => {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast toast-${type}`;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '1'; toast.style.transform = 'translateY(0)'; }, 10);
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(-20px)';
                toast.addEventListener('transitionend', () => toast.remove());
            }, 5000);
        };
        
        // ğŸ’¡ Logic 1: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† UID Ø§Ù„Ø£Ø¯Ù…Ù† Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØµÙ„Ø§Ø­ÙŠØ§ØªÙ‡
        async function checkAdminStatus(uid) {
            if (uid === GIZA_ALLOWED_UID) {
                return true;
            } else {
                window.showToast("âŒ ØºÙŠØ± Ù…ÙØµØ±Ø­ Ù„Ùƒ Ø¨Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù‡Ø°Ù‡ Ø§Ù„Ù„ÙˆØ­Ø©. Ø§Ù„Ù€ UID ØºÙŠØ± Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù€ UID Ø§Ù„Ù…Ø§Ù„Ùƒ.", "error");
                // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø£Ù…Ø§Ù†
                signOut(auth); 
                return false;
            }
        }
        
        // ğŸ’¡ Logic 2: Ø¯Ø§Ù„Ø© Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„ ÙˆØ§Ù„ØªÙˆØ«ÙŠÙ‚ Ù‚Ø¨Ù„ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ©
        async function checkAuthAndProceed(action, ...args) {
            if (!currentUserUid) {
                window.showToast("âŒ ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ù‹Ø§ Ù„Ø¥Ø¬Ø±Ø§Ø¡ Ø£ÙŠ Ø¹Ù…Ù„ÙŠØ©.", "error");
                return;
            }
            // Ø¨Ù…Ø§ Ø£Ù† Ø§Ù„Ù„ÙˆØ­Ø© Ù„Ù† ØªØ¸Ù‡Ø± Ø¥Ù„Ø§ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ØªØ­Ù‚Ù‚ Ù†Ø§Ø¬Ø­Ø§Ù‹ØŒ ÙÙ‡Ø°Ù‡ Ø®Ø·ÙˆØ© Ø£Ù…Ø§Ù† Ø¥Ø¶Ø§ÙÙŠØ©
            if (await checkAdminStatus(currentUserUid)) { 
                action(...args);
            }
        }

        // ğŸ’¡ Logic 3: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ù‚Ù‚)
        window.handleLogin = async (e) => {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            try {
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                const uid = userCredential.user.uid;
                
                window.showToast("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­. Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª...", "success");
                
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„ÙÙˆØ±ÙŠ Ù…Ù† Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ù‚Ø¨Ù„ ÙØªØ­ Ø§Ù„Ù„ÙˆØ­Ø©
                if (await checkAdminStatus(uid)) { 
                    currentUserUid = uid;
                    
                    document.getElementById('loginContainer').style.display = 'none';
                    document.getElementById('mainContent').style.display = 'block';
                    document.getElementById('logoutBtn').style.display = 'block';

                    loadAllCodes(); 
                    
                } 
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…Ø·Ø§Ø¨Ù‚Ø§Ù‹ØŒ ÙØ§Ù„Ø¯Ø§Ù„Ø© checkAdminStatus Ù‚Ø§Ù…Øª Ø¨ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ø§Ù„ÙØ¹Ù„
                // onAuthStateChanged Ø³ØªØªÙƒÙÙ„ Ø¨Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„Ø¯Ø®ÙˆÙ„.

            } catch (error) {
                window.showToast(`âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: ${error.message}`, "error");
            }
        };

        // ğŸ’¡ Logic 4: ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬
        window.logout = async () => {
            await signOut(auth);
            window.showToast("ğŸ‘‹ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨Ù†Ø¬Ø§Ø­.", "warn");
        };

        // ğŸ’¡ Logic 5: ØªÙˆÙ„ÙŠØ¯ ÙƒÙˆØ¯ Ø¹Ø´ÙˆØ§Ø¦ÙŠ ÙØ±ÙŠØ¯
        function generateUniqueCode() {
            let code;
            do {
                code = String(Math.floor(100000 + Math.random() * 900000));
            } while (allCodesData[code]);
            return code;
        }

        // ğŸ’¡ Logic 6: Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„ÙƒÙˆØ¯ Ù…Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ
        window.ejectDevice = (uid, name) => checkAuthAndProceed(() => {
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø®Ø±Ø§Ø¬ ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid}) Ù…Ù† Ø¬Ù‡Ø§Ø²Ù‡ Ø§Ù„Ø­Ø§Ù„ÙŠØŸ`)) return;
            update(ref(db, 'approvedStudents/' + uid), {
                deviceId: "",
            }).then(() => {
                window.showToast(`âœ… ØªÙ… Ø¥Ø®Ø±Ø§Ø¬ ÙƒÙˆØ¯ ${uid} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
            }).catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø®Ø±Ø§Ø¬: " + e.message, "error"));
        });

        // ğŸ’¡ Logic 7: Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯
        window.deleteCode = (uid, name) => checkAuthAndProceed(() => {
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù ÙƒÙˆØ¯ Ø§Ù„Ø·Ø§Ù„Ø¨ ${name} (${uid}) Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ØŸ`)) return;
            remove(ref(db, 'approvedStudents/' + uid))
            .then(() => window.showToast(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„ÙƒÙˆØ¯ ${uid} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`, "success"))
            .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 8: ØªÙØ¹ÙŠÙ„/ØªØ¹Ø·ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯
        window.toggleBlock = (uid, name, isBlocked) => checkAuthAndProceed(() => {
            update(ref(db, 'approvedStudents/' + uid), {
                isBlocked: !isBlocked
            }).then(() => {
                window.showToast(`âœ… ØªÙ… ${!isBlocked ? 'ØªØ¹Ø·ÙŠÙ„' : 'ØªÙØ¹ÙŠÙ„'} ÙƒÙˆØ¯ ${name} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
            }).catch(e => window.showToast("âŒ ÙØ´Ù„ ØªØºÙŠÙŠØ± Ø§Ù„Ø­Ø§Ù„Ø©: " + e.message, "error"));
        });

        // ğŸ’¡ Logic 9: Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (GIZA)
        window.addNewCode = (e) => checkAuthAndProceed(() => {
            e.preventDefault();
            const form = e.target;
            const name = form.studentName.value;
            const price = parseFloat(form.price.value) || 0;
            const durationType = form.durationType.value;
            const customDays = parseInt(form.customDays.value) || 0;
            const newCode = document.getElementById('newCodeDisplay').textContent;
            
            let expiryTime = Date.now();
            
            if (durationType === 'trial') {
                expiryTime += 1 * 60 * 60 * 1000;
            } else if (durationType === '30days') {
                expiryTime += 30 * 24 * 60 * 60 * 1000;
            } else if (durationType === 'custom' && customDays > 0) {
                expiryTime += customDays * 24 * 60 * 60 * 1000;
            } else {
                window.showToast("âŒ ÙŠØ¬Ø¨ ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„.", "error");
                return;
            }

            set(ref(db, 'approvedStudents/' + newCode), {
                uid: newCode,
                name: name,
                pricePaid: price,
                addedByAdmin: CURRENT_ADMIN_ROLE,
                approvedAt: Date.now(),
                expiry: expiryTime,
                deviceId: "",
                isBlocked: false,
                isTrial: durationType === 'trial'
            }).then(() => {
                window.showToast(`âœ… ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙˆØ¯ ${newCode} Ø¨Ù†Ø¬Ø§Ø­.`, "success");
                toggleAddCodeForm(false);
                form.reset();
            }).catch(error => {
                window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©: " + error.message, "error");
            });
        }, e);
        
        // ğŸ’¡ Logic 10: ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase (ØªÙ… Ø§Ù„ØªØ­Ø¯ÙŠØ« Ù„ÙŠØ´Ù…Ù„ blockedDevices)
        function loadAllCodes() {
            // 1. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹ØªÙ…Ø¯Ø©
            onValue(codesRef, (snapshot) => {
                allCodesData = {};
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    data.uid = childSnapshot.key;
                    allCodesData[childSnapshot.key] = data;
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø±Ø¶ Ù„Ùˆ ÙƒØ§Ù† ÙÙŠÙ‡ Tile Ù…ÙØªÙˆØ­Ø©
                if (activeTile) {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§ØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø¹Ø§Ø¯ÙŠØ©
                    if (!activeTile.startsWith('BLOCKED_DEVICES')) { 
                        window.toggleAdminDetails(activeTile, true);
                    } 
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† ÙØ§ØªØ­ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
                    else if (activeTile === 'BLOCKED_DEVICES') { 
                         // Ù†Ø¹ÙŠØ¯ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø¹Ø¯Ø§Ø¯
                         window.toggleBlockedDevicesDetails('TOTAL', true);
                    }
                }
                
                window.showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© GIZA (Ø§Ù„Ø£ÙƒÙˆØ§Ø¯).", "success");
            }, (error) => {
                window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: " + error.message, "error");
            });
            
            // 2. ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
            onValue(blockedDevicesRef, (snapshot) => {
                allBlockedDevices = {};
                snapshot.forEach((childSnapshot) => {
                    const data = childSnapshot.val();
                    data.deviceId = childSnapshot.key;
                    allBlockedDevices[childSnapshot.key] = data;
                });
                window.showToast("âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ù„ÙˆØ­Ø© GIZA (Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©).", "success");
            }, (error) => {
                window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©: " + error.message, "error");
            });
        }

        // ğŸ’¡ Main Auth State Observer (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ù„ØªÙ†Ø¸ÙŠÙ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© Ø¹Ù†Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬)
        onAuthStateChanged(auth, (user) => {
            const loginContainer = document.getElementById('loginContainer');
            const mainContent = document.getElementById('mainContent');
            const logoutBtn = document.getElementById('logoutBtn');
            
            if (user) {
                currentUserUid = user.uid; 
                
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„Ù‡ Ø¨Ø§Ù„ÙØ¹Ù„ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© (Reload)
                checkAdminStatus(user.uid).then(isVerified => {
                    if (isVerified) {
                        loginContainer.style.display = 'none';
                        mainContent.style.display = 'block';
                        logoutBtn.style.display = 'block';
                        loadAllCodes(); // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    } else {
                         // Ø¥Ø°Ø§ ÙØ´Ù„ Ø§Ù„ØªØ­Ù‚Ù‚ (ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ù€ Reload)ØŒ Ù†ØºÙ„Ù‚ Ø§Ù„Ù„ÙˆØ­Ø©
                         currentUserUid = null;
                         loginContainer.style.display = 'block';
                         mainContent.style.display = 'none';
                         logoutBtn.style.display = 'none';
                    }
                });

            } else {
                currentUserUid = null;
                loginContainer.style.display = 'block';
                mainContent.style.display = 'none';
                logoutBtn.style.display = 'none';
                // Ø¥ÙØ±Ø§Øº Ø§Ù„Ø¯Ø§ØªØ§
                document.getElementById('codeDetailsContainer').innerHTML = '<p style="text-align:center; color:var(--secondary);">Ø¨Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>';
                activeTile = null; 
            }
        });

        // ğŸ’¡ Ø§Ù„Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„Ø¹Ø±Ø¶
        
        function formatExpiry(timestamp) {
            const now = Date.now();
            if (timestamp < now) return '<span style="color:red; font-weight:bold;">Ù…Ù†ØªÙ‡ÙŠ</span>';
            const diff = timestamp - now;
            const days = Math.floor(diff / (1000 * 60 * 60 * 24));
            const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
            return `${days}ÙŠ ${hours}Ø³`;
        }
        
        // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØµÙ†ÙŠÙ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯
        function categorizeCodes(codes) {
            const now = Date.now();
            return codes.reduce((acc, code) => {
                const isExpired = code.expiry < now;
                const isBlocked = code.isBlocked === true;

                if (isExpired) {
                    acc.expired.push(code);
                } else if (isBlocked) {
                    acc.manuallyBlocked.push(code);
                } else {
                    acc.active.push(code);
                }
                return acc;
            }, { active: [], manuallyBlocked: [], expired: [] });
        }

        // ğŸ’¡ Logic 13: ØªØ¬Ø¯ÙŠØ¯ ØµÙ„Ø§Ø­ÙŠØ© Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ/Ø§Ù„Ù‚Ø§Ø¦Ù…
        window.renewCode = (uid, name) => checkAuthAndProceed(() => {
            const daysStr = prompt(`ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø±Ø§Ø¯ ØªØ¬Ø¯ÙŠØ¯ ÙƒÙˆØ¯ ${name} (${uid}) Ø¨Ù‡Ø§ØŸ`);
            if (!daysStr) return;
            const days = parseInt(daysStr);
            if (isNaN(days) || days <= 0) {
                window.showToast("âŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ Ø£ÙŠØ§Ù… ØµØ­ÙŠØ­ ÙˆÙ…ÙˆØ¬Ø¨.", "error");
                return;
            }
            
            const priceStr = prompt(`ÙƒÙ… Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ù„ØªØ¬Ø¯ÙŠØ¯ ÙƒÙˆØ¯ ${name} (${uid}) Ù„Ù…Ø¯Ø© ${days} Ø£ÙŠØ§Ù…ØŸ`);
            if (!priceStr) return;
            const price = parseFloat(priceStr);
            if (isNaN(price) || price < 0) {
                window.showToast("âŒ ÙŠØ¬Ø¨ Ø¥Ø¯Ø®Ø§Ù„ Ù…Ø¨Ù„Øº ØµØ­ÙŠØ­.", "error");
                return;
            }
            
            const currentCodeData = allCodesData[uid];
            if (!currentCodeData) {
                window.showToast("âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒÙˆØ¯.", "error");
                return;
            }

            let newExpiryTime;
            const now = Date.now();
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙƒÙˆØ¯ Ù…Ù†ØªÙ‡ÙŠ Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©ØŒ ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ø¢Ù†.
            if (currentCodeData.expiry < now) {
                 newExpiryTime = now + (days * 24 * 60 * 60 * 1000);
                 window.showToast(`â˜‘ï¸ ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠ ÙˆØªÙ…Ø¯ÙŠØ¯Ù‡ Ù„Ù€ ${days} ÙŠÙˆÙ….`, "warn");
            } 
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ø§ ÙŠØ²Ø§Ù„ Ø³Ø§Ø±ÙŠÙ‹Ø§ØŒ ÙŠØ¨Ø¯Ø£ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ Ù…Ù† ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„Ø­Ø§Ù„ÙŠ.
            else {
                 newExpiryTime = currentCodeData.expiry + (days * 24 * 60 * 60 * 1000);
                 window.showToast(`â˜‘ï¸ ØªÙ… ØªÙ…Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ¥Ø¶Ø§ÙØ© ${days} ÙŠÙˆÙ….`, "success");
            }

            // ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù‚Ø¯ÙŠÙ…
            const totalAmount = (currentCodeData.pricePaid || 0) + price;
            
            const updates = {
                expiry: newExpiryTime,
                isBlocked: false, // ÙŠØªÙ… ØªÙØ¹ÙŠÙ„Ù‡ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯ 
                pricePaid: totalAmount
            };

            update(ref(db, 'approvedStudents/' + uid), updates)
            .then(() => {
                window.showToast(`âœ… ØªÙ… ØªØ¬Ø¯ÙŠØ¯ ÙƒÙˆØ¯ ${name} (${uid}) Ù„Ù…Ø¯Ø© ${days} Ø£ÙŠØ§Ù… ÙˆØ§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¢Ù† ${totalAmount.toLocaleString()} Ø¬.Ù….`, "success");
            })
            .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„ØªØ¬Ø¯ÙŠØ¯: " + e.message, "error"));
        });


        // ğŸ’¡ Logic 11: Ø¹Ø±Ø¶ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø¨Ø¹Ø¯ Ø§Ù„ÙÙ„ØªØ±Ø© 
        window.renderFilteredCodesTable = (adminRole, categoryKey, categoryName) => {
            const filteredCodes = window.currentCategorizedData[categoryKey] || [];
            
            const container = document.getElementById('codeDetailsContainer');
            let totalAmount = 0;
            
            container.innerHTML = `
                <h2 style="color:var(--primary); text-align:center;">${categoryName} Ù„Ù€ ${adminRole === 'TOTAL' ? 'Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø¯Ù…Ù†Ø²' : adminRole} (${filteredCodes.length} ÙƒÙˆØ¯)</h2>
                <button class="add-code-btn" style="width: auto; margin: 10px auto 20px auto; display: block; background: #555; color: var(--text-light);" onclick="toggleAdminDetails('${adminRole}', true)">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ
                </button>
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>Ø§Ù„ÙƒÙˆØ¯ (UID)</th>
                                <th>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                                <th>Ø§Ù„Ù…Ø¨Ù„Øº</th>
                                <th>Ù…Ø¯Ø© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</th>
                                <th>Ø­Ø§Ù„Ø© Ø§Ù„ÙƒÙˆØ¯</th>
                                <th>Ø¬Ù‡Ø§Ø² Ø§Ù„ØªÙØ¹ÙŠÙ„</th>
                                ${adminRole === 'TOTAL' ? '<th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>' : ''}
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="admin-stats-footer" id="adminStats_filtered"></div>
            `;
            
            const tbody = container.querySelector('tbody');
            
            filteredCodes.forEach(data => {
                totalAmount += (data.pricePaid || 0);
                const isBlocked = data.isBlocked === true;
                const isExpired = data.expiry < Date.now();
                
                let statusText = isExpired ? 'Ù…Ù†ØªÙ‡ÙŠ' : (isBlocked ? 'Ù…ÙØ¹Ø·Ù‘Ù„' : 'Ù†Ø´Ø·');
                let statusClass = isExpired ? 'status-expired' : (isBlocked ? 'status-blocked' : 'status-active');
                
                const blockBtnText = isBlocked ? 'ØªÙØ¹ÙŠÙ„' : 'ØªØ¹Ø·ÙŠÙ„';
                let actionsHtml;
                
                // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ù†ØªÙ‡ÙŠØ©
                if (categoryKey === 'expired') { 
                    actionsHtml = `
                        <button onclick="renewCode('${data.uid}', '${data.name}')" class="unblock-btn" style="background: #007bff; color: white;">ØªØ¬Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙˆØ¯</button>
                        <button onclick="deleteCode('${data.uid}', '${data.name}')" class="delete-btn">Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ</button>
                    `;
                } else {
                    // Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¹Ø§Ø¯ÙŠØ© Ù„Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù†Ø´Ø·Ø© ÙˆØ§Ù„Ù…Ø¹Ø·Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
                    actionsHtml = `
                        <button onclick="ejectDevice('${data.uid}', '${data.name}')" class="eject-btn">Ø¥Ø®Ø±Ø§Ø¬ Ø§Ù„Ø¬Ù‡Ø§Ø²</button>
                        <button onclick="toggleBlock('${data.uid}', '${data.name}', ${isBlocked})" class="${isBlocked ? 'unblock-btn' : 'block-btn'}">${blockBtnText}</button>
                        <button onclick="deleteCode('${data.uid}', '${data.name}')" class="delete-btn">Ø­Ø°Ù</button>
                    `;
                }
                
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="code-uid">${data.uid}</td>
                    <td>${data.name}</td>
                    <td>${data.pricePaid} Ø¬.Ù…</td>
                    <td style="min-width: 90px;">${formatExpiry(data.expiry)}</td>
                    <td class="${statusClass}">${statusText}</td>
                    <td class="device-id">${data.deviceId || 'ØºÙŠØ± Ù…ÙÙØ¹Ù„'}</td>
                    ${adminRole === 'TOTAL' ? `<td>${data.addedByAdmin || '-'}</td>` : ''}
                    <td class="actions" style="min-width: 250px;">${actionsHtml}</td>
                `;
                tbody.appendChild(tr);
            });
            
            const footer = document.getElementById(`adminStats_filtered`);
            footer.innerHTML = `
                <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: <strong>${filteredCodes.length}</strong> | Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø­ØµÙ‘Ù„ Ù…Ù†Ù‡Ø§: <strong style="color: var(--secondary);">${totalAmount.toLocaleString()} Ø¬.Ù…</strong></p>
            `;
        }

        // ğŸ’¡ Logic 12: Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„ØªØµÙ†ÙŠÙ Ø§Ù„Ø«Ù„Ø§Ø«Ø©
        window.toggleAdminDetails = (adminRole, forceOpen = false) => {
             checkAuthAndProceed(() => {
                const container = document.getElementById('codeDetailsContainer');

                document.querySelectorAll('.admin-tile').forEach(tile => tile.classList.remove('active-tile'));
                
                let codesToFilter = [];
                if (adminRole === 'TOTAL') {
                    codesToFilter = Object.values(allCodesData);
                } else if (adminRole === 'BLOCKED_DEVICES') {
                    // Ù†ØºÙ„Ù‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆÙ†ÙØªØ­ Ù„ÙˆØ­Ø© Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
                    window.toggleBlockedDevicesDetails('TOTAL', true);
                    return; 
                } else {
                    codesToFilter = Object.values(allCodesData).filter(code => (code.addedByAdmin || 'giza').toLowerCase() === adminRole.toLowerCase());
                }

                if (activeTile !== adminRole || forceOpen) {
                    
                    document.getElementById(`tile_${adminRole.toLowerCase().replace('total', 'total')}`).classList.add('active-tile');
                    activeTile = adminRole;

                    const categorized = categorizeCodes(codesToFilter);
                    
                    window.currentCategorizedData = categorized;
                    
                    container.innerHTML = `
                        <h2 style="color:var(--primary); text-align:center;">Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯: ${adminRole === 'TOTAL' ? 'Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ÙƒÙ„ÙŠØ©' : adminRole}</h2>
                        <div class="admin-tiles sub-tiles-container">
                            <div class="admin-tile" onclick="renderFilteredCodesTable('${adminRole}', 'active', 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙØ¹Ù„Ø©')">
                                <h3>${categorized.active.length}</h3>
                                <p style="color:var(--primary);">Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙØ¹Ù„Ø©</p>
                            </div>
                            <div class="admin-tile" style="border-color:var(--warn);" onclick="renderFilteredCodesTable('${adminRole}', 'manuallyBlocked', 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙØ¹Ø·Ù„Ø© ÙŠØ¯ÙˆÙŠÙ‹Ø§')">
                                <h3>${categorized.manuallyBlocked.length}</h3>
                                <p style="color:var(--warn);">Ø§Ù„Ù…ÙØ¹Ø·Ù„Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹</p>
                            </div>
                            <div class="admin-tile" style="border-color:var(--error);" onclick="renderFilteredCodesTable('${adminRole}', 'expired', 'Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ù…ÙÙ†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©')">
                                <h3>${categorized.expired.length}</h3>
                                <p style="color:var(--error);">Ù…ÙÙ†ØªÙ‡ÙŠØ© Ø§Ù„ØµÙ„Ø§Ø­ÙŠØ©</p>
                            </div>
                        </div>
                        <div class="admin-stats-footer" style="max-width: 900px; margin: 30px auto;">
                           <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø£ÙƒÙˆØ§Ø¯ ${adminRole === 'TOTAL' ? 'Ø§Ù„Ù…Ù†ØµØ©' : adminRole}: <strong>${codesToFilter.length}</strong></p>
                           <p>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯: <strong style="color: var(--secondary);">${codesToFilter.reduce((sum, data) => sum + (data.pricePaid || 0), 0).toLocaleString()} Ø¬.Ù…</strong></p>
                        </div>
                        <p style="text-align:center; margin-top: 20px; color:#999;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©.</p>
                    `;
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¶ØºØ· Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„
                    container.innerHTML = '<p style="text-align:center; color:var(--secondary);">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>';
                    activeTile = null;
                }
            });
        };
        
        window.toggleAddCodeForm = (show) => {
            const form = document.getElementById('addCodeFormContainer');
            if (show) {
                checkAuthAndProceed(() => {
                    form.style.display = 'block';
                    document.getElementById('newCodeDisplay').textContent = generateUniqueCode();
                });
            } else {
                form.style.display = 'none';
            }
        };

        // ğŸ’¡ Logic 14: Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© GIZA
        window.addBlockedDevice = () => checkAuthAndProceed(() => {
            const deviceId = prompt("Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² (Device ID) Ø§Ù„Ø°ÙŠ ØªØ±ÙŠØ¯ Ø­Ø¸Ø±Ù‡ØŒ Ù…Ø«Ø§Ù„: DID-X1VZM373mj7ddqkz");
            if (!deviceId || deviceId.trim() === "") return;

            const notes = prompt("Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø­Ø¸Ø± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):");

            // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·Ø© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ù„ØªÙˆÙÙŠØ± Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¹Ù†Ù‡Ø§
            const relatedCodes = Object.values(allCodesData).filter(code => code.deviceId === deviceId.trim());
            const relatedCodesString = relatedCodes.map(c => `${c.uid} (${c.name})`).join(' | ');
            const relatedStudents = relatedCodes.map(c => c.name).join(', ') || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø§Ø¨ Ù…Ø³Ø¬Ù„ÙˆÙ†";

            set(ref(db, 'blockedDevices/' + deviceId.trim()), {
                deviceId: deviceId.trim(),
                blockedBy: CURRENT_ADMIN_ROLE, // GIZA
                timestamp: Date.now(),
                notes: notes || "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª",
                relatedCodes: relatedCodesString || "Ù„Ù… ÙŠÙØ³Ø¬Ù‘ÙÙ„ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙŠ ÙƒÙˆØ¯",
                relatedStudents: relatedStudents
            }).then(() => {
                window.showToast(`âœ… ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${deviceId} Ø¨Ù†Ø¬Ø§Ø­ Ø¨ÙˆØ§Ø³Ø·Ø© ${CURRENT_ADMIN_ROLE}.`, "success");
            }).catch(error => {
                window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø¸Ø±: " + error.message, "error");
            });
        });
        
        // ğŸ’¡ Logic 15: Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² (Ø­Ø°ÙÙ‡ Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©)
        window.unblockDevice = (deviceId) => checkAuthAndProceed(() => {
            if (!confirm(`Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² (${deviceId})ØŸ Ø³ÙŠØªÙ… Ø­Ø°ÙÙ‡ Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`)) return;
            remove(ref(db, 'blockedDevices/' + deviceId))
            .then(() => window.showToast(`âœ… ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø¬Ù‡Ø§Ø² ${deviceId} Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹.`, "success"))
            .catch(e => window.showToast("âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ù„ØºØ§Ø¡: " + e.message, "error"));
        });
        
        // ğŸ’¡ Logic 16: Ø¹Ø±Ø¶ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
        window.renderBlockedDevicesTable = (adminRole) => {
            const container = document.getElementById('codeDetailsContainer');
            
            // ÙÙ„ØªØ±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙØŒ Ø£Ùˆ Ø¹Ø±Ø¶ Ø§Ù„ÙƒÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù† TOTAL
            const filteredDevices = Object.values(allBlockedDevices).filter(device => 
                device.blockedBy.toLowerCase() === adminRole.toLowerCase()
            );
            
            const isGiza = adminRole.toLowerCase() === 'giza';
            const title = isGiza ? 'Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© GIZA' : 
                          (adminRole === 'sara' ? 'Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Sara' : 'Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ahmed');
            
            container.innerHTML = `
                <h2 style="color:var(--error); text-align:center;">${title} (${filteredDevices.length} Ø¬Ù‡Ø§Ø²)</h2>
                <button class="add-code-btn" style="width: auto; margin: 10px auto 20px auto; display: block; background: #555; color: var(--text-light);" onclick="toggleBlockedDevicesDetails('TOTAL', true)">
                    â† Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ†
                </button>
                ${isGiza ? `
                <button class="add-code-btn" style="background: var(--error); color: var(--text-light); width: auto; margin: 10px auto 20px auto; display: block;" onclick="addBlockedDevice()">
                    ğŸš« Ø­Ø¸Ø± Ø¬Ù‡Ø§Ø² Ø¬Ø¯ÙŠØ¯
                </button>
                ` : ''}
                <div class="table-responsive">
                    <table>
                        <thead>
                            <tr>
                                <th>ÙƒÙˆØ¯ Ø§Ù„Ø¬Ù‡Ø§Ø² (Device ID)</th>
                                <th>Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø±ØªØ¨Ø·ÙˆÙ†</th>
                                <th>Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…ÙÙØ¹Ù‘ÙÙ„Ø© Ø¹Ù„Ù‰ Ø§Ù„Ø¬Ù‡Ø§Ø²</th>
                                <th>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø­Ø¸Ø±</th>
                                <th>Ø¨ÙˆØ§Ø³Ø·Ø©</th>
                                <th>Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="admin-stats-footer">
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø§Ù„Ù…Ø¹Ø±ÙˆØ¶Ø©: <strong>${filteredDevices.length}</strong></p>
                </div>
            `;
            
            const tbody = container.querySelector('tbody');
            
            filteredDevices.forEach(data => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="code-uid">${data.deviceId}</td>
                    <td>${data.relatedStudents || 'N/A'}</td>
                    <td>${data.relatedCodes || 'N/A'}</td>
                    <td>${new Date(data.timestamp).toLocaleString('ar-EG')}</td>
                    <td>${data.blockedBy || 'N/A'}</td>
                    <td class="actions">
                        <button onclick="unblockDevice('${data.deviceId}')" class="unblock-btn" style="background: #007bff; color: white;">Ø­Ø°Ù Ù…Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        // ğŸ’¡ Logic 17: Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø§Øª Ø§Ù„Ù…Ø´Ø±ÙÙŠÙ† Ù„Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©
        window.toggleBlockedDevicesDetails = (forceAdmin = 'TOTAL', forceOpen = false) => {
            checkAuthAndProceed(() => {
                const container = document.getElementById('codeDetailsContainer');
                const adminRole = 'BLOCKED_DEVICES'; // Ù„ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù€ Active Tile
                
                document.querySelectorAll('.admin-tile').forEach(tile => tile.classList.remove('active-tile'));
                
                // ÙÙŠ Ø­Ø§Ù„ Ø§Ù„Ø¹ÙˆØ¯Ø© Ù…Ù† Ø¬Ø¯ÙˆÙ„ Ù…ÙÙ„ØªØ±ØŒ ÙŠØ¬Ø¨ ØªÙØ¹ÙŠÙ„ Tile Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©
                if (forceAdmin === 'TOTAL' || forceOpen) {
                    document.getElementById('tile_blocked_devices').classList.add('active-tile');
                }
                
                const saraCount = Object.values(allBlockedDevices).filter(d => d.blockedBy.toLowerCase() === 'sara').length;
                const ahmedCount = Object.values(allBlockedDevices).filter(d => d.blockedBy.toLowerCase() === 'ahmed').length;
                const gizaCount = Object.values(allBlockedDevices).filter(d => d.blockedBy.toLowerCase() === 'giza').length;

                if (activeTile !== adminRole || forceOpen || !container.querySelector('.sub-tiles-container')) {
                    activeTile = adminRole;
                    
                    container.innerHTML = `
                        <h2 style="color:var(--error); text-align:center;">Ø¥Ø¯Ø§Ø±Ø© Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© ğŸš«</h2>
                        <div class="admin-tiles sub-tiles-container">
                            <div class="admin-tile" id="blocked_tile_sara" style="border-color: var(--error);" onclick="renderBlockedDevicesTable('sara')">
                                <h3>${saraCount}</h3>
                                <p style="color:var(--error);">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Sara</p>
                            </div>
                            <div class="admin-tile" id="blocked_tile_ahmed" style="border-color: var(--error);" onclick="renderBlockedDevicesTable('ahmed')">
                                <h3>${ahmedCount}</h3>
                                <p style="color:var(--error);">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© Ahmed</p>
                            </div>
                            <div class="admin-tile" id="blocked_tile_giza" style="border-color: var(--error);" onclick="renderBlockedDevicesTable('giza')">
                                <h3>${gizaCount}</h3>
                                <p style="color:var(--error);">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø© Ø¨ÙˆØ§Ø³Ø·Ø© GIZA</p>
                            </div>
                        </div>
                        <p style="text-align:center; margin-top: 20px; color:#999;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©.</p>
                    `;
                } else {
                    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¶ØºØ· Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªÙØ§ØµÙŠÙ„ (ÙÙŠ Ø­Ø§Ù„ ÙƒÙ†Ø§ Ù†Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©)
                    container.innerHTML = '<p style="text-align:center; color:var(--secondary);">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>';
                    activeTile = null;
                }
            });
        };
        

    </script>
    <style>
        :root {
            --bg-dark: #111;
            --primary: #00FF00; /* Cyber Green */
            --secondary: #00E8C8; 
            --text-light: #F0F0F0;
            --error: #FF4444;
            --warn: #FFA500;
            --bg-mid: #222;
            --hover-dark: #333;
            --tile-bg: #1A1A1A;
            --tile-shadow: 0 0 15px rgba(0, 255, 0, 0.4);
        }
        * { box-sizing: border-box; font-family: 'Cairo', sans-serif; }
        body { background: var(--bg-dark); color: var(--text-light); margin: 0; padding: 0; }
        .container { max-width: 1200px; margin: 30px auto; padding: 20px; }
        h1 { color: var(--primary); text-align: center; margin-bottom: 25px; border-bottom: 2px solid var(--bg-mid); padding-bottom: 10px; }
        
        /* Login Style */
        #loginContainer { background: var(--bg-mid); padding: 30px; border-radius: 10px; max-width: 400px; margin: 100px auto; }
        #loginContainer h2 { color: var(--secondary); text-align: center; margin-bottom: 20px; }
        #loginContainer input { width: 100%; padding: 10px; margin-bottom: 15px; border: 1px solid #444; border-radius: 5px; background: #333; color: var(--text-light); }
        #loginContainer button { width: 100%; padding: 10px; background: var(--primary); color: var(--bg-dark); border: none; border-radius: 5px; font-weight: 700; cursor: pointer; transition: 0.3s; }
        #loginContainer button:hover { background: #00cc00; }
        
        /* Main Content Style */
        #mainContent { display: none; }
        .header-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        #logoutBtn { background: var(--error); color: var(--text-light); padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: 700; }
        #logoutBtn:hover { background: #cc3333; }
        
        /* Tiles Section */
        .admin-tiles { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin-bottom: 40px; }
        .sub-tiles-container { justify-content: space-around; max-width: 900px; margin: 30px auto; } 

        .admin-tile {
            background: var(--tile-bg); color: var(--text-light); padding: 25px; 
            border-radius: 15px; width: 250px; text-align: center; cursor: pointer;
            border: 2px solid var(--secondary); transition: all 0.3s ease;
            box-shadow: 0 0 10px rgba(0, 255, 0, 0.2);
        }
        .admin-tile:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: var(--tile-shadow); }
        .admin-tile h3 { margin: 0; font-size: 24px; color: var(--primary); }
        .admin-tile.active-tile { background: var(--primary); color: var(--bg-dark); transform: scale(1.05); }
        .admin-tile.active-tile h3 { color: var(--bg-dark); }
        #tile_blocked_devices.active-tile { background: var(--error); color: var(--text-light); border-color: var(--error); }
        #tile_blocked_devices.active-tile h3 { color: var(--text-light); }


        /* Add Code Button */
        .add-code-btn {
            background: var(--secondary); color: var(--bg-dark); padding: 12px 25px; 
            border: none; border-radius: 8px; font-weight: 700; cursor: pointer; 
            transition: 0.3s; margin-bottom: 20px; display: block; width: 250px; margin: 0 auto 20px auto;
        }
        .add-code-btn:hover { background: var(--primary); }

        /* Code Details Section */
        #codeDetailsContainer { background: var(--bg-mid); padding: 20px; border-radius: 10px; margin-top: 30px; }
        .table-responsive { overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 10px; border: 1px solid #444; text-align: right; font-size: 14px; }
        th { background: #333; color: var(--primary); }
        tr:nth-child(even) { background: #1a1a1a; }
        .code-uid, .device-id { font-family: monospace; font-size: 12px; direction: ltr; text-align: left; color: var(--secondary); }

        /* Status & Actions */
        .status-active { color: var(--primary); font-weight: 700; }
        .status-blocked { color: var(--warn); font-weight: 700; }
        .status-expired { color: color: var(--error); font-weight: 700; } 

        .actions button {
            padding: 5px 10px; border: none; border-radius: 5px; cursor: pointer; margin: 2px; font-weight: 700; transition: 0.2s;
        }
        .eject-btn { background: #0099cc; color: var(--text-light); }
        .block-btn { background: var(--warn); color: var(--bg-dark); }
        .unblock-btn { background: var(--primary); color: var(--bg-dark); }
        .delete-btn { background: var(--error); color: var(--text-light); }

        /* Footer Stats */
        .admin-stats-footer { text-align: center; padding: 15px; background: #333; margin-top: 15px; border-radius: 8px; font-size: 16px; }

        /* Add Code Form */
        #addCodeFormContainer {
            display: none; background: #0a0a0a; padding: 25px; border-radius: 10px; margin-top: 20px;
            border: 2px solid var(--secondary); max-width: 500px; margin-left: auto; margin-right: auto;
        }
        #newCodeDisplay { font-family: monospace; font-size: 18px; color: var(--primary); font-weight: 700; direction: ltr; text-align: left; background: #111; padding: 5px; border-radius: 5px; }
        #addCodeFormContainer input, #addCodeFormContainer select {
            width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #444; border-radius: 5px; background: #333; color: var(--text-light);
            margin-bottom: 10px;
        }
        .form-actions { display: flex; justify-content: space-between; gap: 10px; margin-top: 20px;}
        .form-actions button.add-code-btn { width: 70%; margin: 0; }
        .form-actions button.delete-btn { width: 30%; margin: 0; background: #555; }


        /* Toast */
        #toast-container { position: fixed; bottom: 20px; left: 20px; z-index: 10000; }
        .toast { padding: 12px 20px; border-radius: 10px; margin-top: 10px; font-weight: 700; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.5); opacity: 0; animation: toastIn 0.5s forwards; transition: opacity 0.5s, transform 0.5s; min-width: 200px; text-align: right; }
        .toast-success { background: var(--primary); color: var(--bg-dark); }
        .toast-error { background: var(--error); color: var(--text-light); }
        .toast-warn { background: var(--warn); color: var(--bg-dark); }
    </style>
</head>
<body>

<div class="container">
    
    <div id="loginContainer">
        <h2>ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø§Ù„Ùƒ Ø§Ù„Ù…Ù†ØµØ© (GIZA)</h2>
        <form id="loginForm" onsubmit="handleLogin(event)">
            <input type="email" id="loginEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" required>
            <input type="password" id="loginPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" required>
            <button type="submit">Ø¯Ø®ÙˆÙ„ ğŸ›¡ï¸</button>
        </form>
    </div>

    <div id="mainContent">
        <div class="header-controls">
            <div class="giza-logo" style="color:var(--secondary); font-size:24px;">GIZA - Ù„ÙˆØ­Ø© Ø§Ù„Ù…Ø§Ù„Ùƒ ğŸ‘‘</div>
            <button id="logoutBtn" onclick="logout()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</button>
        </div>
        
        <button class="add-code-btn" onclick="toggleAddCodeForm(true)">+ Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ (GIZA)</button>
        
        <div id="addCodeFormContainer">
            <h3>Ø¥Ø¶Ø§ÙØ© ÙƒÙˆØ¯ Ø¬Ø¯ÙŠØ¯ Ø¨ÙˆØ§Ø³Ø·Ø© GIZA</h3>
            <p>Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø¹Ø´ÙˆØ§Ø¦ÙŠ Ø§Ù„Ù…ÙÙˆÙ„Ù‘ÙØ¯: <span id="newCodeDisplay">...</span></p>
            <form id="addCodeForm" onsubmit="addNewCode(event)">
                <label>Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨:</label>
                <input type="text" name="studentName" required>
                
                <label>Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ù…Ø¯ÙÙˆØ¹ (Ø¬Ù†ÙŠÙ‡):</label>
                <input type="number" name="price" min="0" value="0">

                <label>Ù…Ø¯Ø© Ø§Ù„ØªÙØ¹ÙŠÙ„:</label>
                <select name="durationType" onchange="document.getElementById('customDaysField').style.display = (this.value === 'custom' ? 'block' : 'none')" required>
                    <option value="">Ø§Ø®ØªØ± Ø§Ù„Ù…Ø¯Ø©</option>
                    <option value="trial">ØªØ¬Ø±ÙŠØ¨ÙŠ (Ø³Ø§Ø¹Ø© ÙˆØ§Ø­Ø¯Ø©)</option>
                    <option value="30days">Ø§Ø´ØªØ±Ø§Ùƒ 30 ÙŠÙˆÙ…</option>
                    <option value="custom">ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø¨Ø§Ù„Ø£ÙŠØ§Ù…</option>
                </select>
                
                <div id="customDaysField" style="display:none; margin-top:10px;">
                    <label>Ø¹Ø¯Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø®ØµØµØ©:</label>
                    <input type="number" name="customDays" min="1" value="1">
                </div>

                <div class="form-actions">
                    <button type="submit" class="add-code-btn">Ø­ÙØ¸ ÙˆØªÙØ¹ÙŠÙ„ Ø§Ù„ÙƒÙˆØ¯</button>
                    <button type="button" class="delete-btn" onclick="toggleAddCodeForm(false)">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
        
        <h2>Ù„ÙˆØ­Ø§Øª ØªØ­ÙƒÙ… Ø§Ù„Ø£Ø¯Ù…Ù†Ø²</h2>
        <div class="admin-tiles">
            <div id="tile_sara" class="admin-tile" onclick="toggleAdminDetails('sara')">
                <h3>Sara</h3>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø³Ø§Ø±Ø©</p>
            </div>
            <div id="tile_ahmed" class="admin-tile" onclick="toggleAdminDetails('ahmed')">
                <h3>Ahmed</h3>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ø£ÙƒÙˆØ§Ø¯ Ø£Ø­Ù…Ø¯</p>
            </div>
            <div id="tile_giza" class="admin-tile" onclick="toggleAdminDetails('giza')">
                <h3>GIZA (Ø£ÙƒÙˆØ§Ø¯Ùƒ)</h3>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ Ø§Ù„Ù…Ø¶Ø§ÙØ© Ø¨ÙˆØ§Ø³Ø·ØªÙƒ</p>
            </div>
            <div id="tile_blocked_devices" class="admin-tile" style="border-color:var(--error);" onclick="toggleBlockedDevicesDetails('TOTAL')">
                <h3>ğŸš« Ø­Ø¸Ø± Ø§Ù„Ø£Ø¬Ù‡Ø²Ø©</h3>
                <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ø§Ù„Ù…Ø­Ø¸ÙˆØ±Ø©</p>
            </div>
            <div id="tile_total" class="admin-tile" onclick="toggleAdminDetails('TOTAL')">
                <h3>ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØµØ© Ø§Ù„ÙƒÙ„ÙŠØ©</h3>
                <p>Ø¹Ø±Ø¶ ÙƒÙ„ Ø§Ù„Ø£ÙƒÙˆØ§Ø¯ ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº</p>
            </div>
        </div>
        
        <div id="codeDetailsContainer">
            <p style="text-align:center; color:var(--secondary);">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø¥Ø­Ø¯Ù‰ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>
        </div>
    </div>

</div>

<div id="toast-container"></div>
</body>
</html>
